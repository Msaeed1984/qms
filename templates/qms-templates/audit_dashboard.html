{% include "qms-templates/header.html" %}

<style>
body{background:#f4f7fb;}

.page{
  width:100%;
  margin:30px 0;
  padding:0 30px 60px;
}

.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.kpi{
  background:#fff;
  padding:24px;
  border-radius:20px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);
}

.kpi h3{
  margin:0;
  font-size:13px;
  text-transform:uppercase;
  color:#006EB3;
}

.kpi .value{
  font-size:30px;
  font-weight:900;
  margin-top:10px;
}

.security-alerts{
  background:#fff5f5;
  border:1px solid #fecaca;
  padding:20px;
  border-radius:20px;
  margin-bottom:30px;
}

.alert-box{
  padding:12px 16px;
  border-radius:12px;
  margin-bottom:10px;
  font-weight:600;
}

.alert-box.danger{
  background:#fee2e2;
  color:#b91c1c;
}

.alert-box.warning{
  background:#fff7ed;
  color:#c2410c;
}

.card{
  background:#fff;
  padding:24px;
  border-radius:12px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);
  margin-bottom:30px;
}

.chart-wrap{
  height: 320px;          /* ÿ∫ŸäŸëÿ± ÿßŸÑÿ±ŸÇŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑŸÑŸä ŸäŸÜÿßÿ≥ÿ®ŸÉ */
  position: relative;
}

table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  padding:12px;
  border-bottom:1px solid rgba(0,0,0,.08);
  font-size:13px;
}

th{
  text-align:left;
  font-weight:900;
  color:#006EB3;
}
</style>

<div class="page">

  <h2 style="margin-bottom:30px;">üìä Security Monitoring Dashboard</h2>

  <!-- ================= KPIs ================= -->
  <div class="kpi-grid">
    <div class="kpi">
      <h3>Total Logs</h3>
      <div class="value">{{ total_logs|default:0 }}</div>
    </div>

    <div class="kpi">
      <h3>Today Logs</h3>
      <div class="value">{{ today_logs|default:0 }}</div>
    </div>

    <div class="kpi">
      <h3>Disabled Attempts Today</h3>
      <div class="value">{{ disabled_today|default:0 }}</div>
    </div>

    <div class="kpi">
      <h3>Most Active User</h3>
      <div class="value">
        {% if most_active_user %}
          {{ most_active_user.user__username }}
        {% else %}
          -
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ================= SECURITY ALERTS ================= -->
  {% if suspicious_users or risky_documents %}
  <div class="security-alerts">
    <h3>üö® Security Alerts (Last 24 Hours)</h3>

    {% for user in suspicious_users %}
      <div class="alert-box danger">
        ‚ö†Ô∏è User {{ user.user__username }} attempted {{ user.total }} disabled accesses.
      </div>
    {% endfor %}

    {% for doc in risky_documents %}
      <div class="alert-box warning">
        ‚ö†Ô∏è Document {{ doc.document__title }} has {{ doc.total }} blocked attempts.
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ================= CHART ================= -->
  <div class="card">
    <h3>Activity Distribution</h3>
   <div class="chart-wrap">
  <canvas id="activityChart"></canvas>
  </div>
  </div>

  <!-- ================= RECENT LOGS ================= -->
  <div class="card">
    <h3>Recent Activity</h3>
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Action</th>
          <th>Document</th>
          <th>Department</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% for log in page_obj %}
        <tr {% if log.action == "attempt_disabled" %}style="background:#fff1f2;"{% endif %}>
          <td>{{ log.user.username|default:"System" }}</td>
          <td>{{ log.get_action_display }}</td>
          <td>{{ log.document.title }}</td>
          <td>{{ log.department.name|default:"-" }}</td>
          <td>{{ log.timestamp }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" style="text-align:center;">No activity recorded.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- ================= CHART SCRIPT ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const ctx = document.getElementById('activityChart');
  if(!ctx) return;

  let labels = [];
  let data = [];

  try {
    labels = JSON.parse('{{ context_labels|escapejs }}');
    data = JSON.parse('{{ context_data|escapejs }}');
  } catch(e){
    console.error("Chart data parsing error:", e);
  }

  if(labels.length > 0){
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Activity Count',
          data: data,
          backgroundColor: [
            '#006EB3',
            '#1F9D55',
            '#F5A524',
            '#E11D48'
          ],
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

});
</script>

{% include "qms-templates/footer.html" %}