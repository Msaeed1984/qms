{% include "qms-templates/header.html" %}

<style>
body{background:#f4f7fb;}

.page{
  width:100%;
  margin:30px 0;
  padding:0 30px 60px;
}

/* HEADER */
.page-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}

.page-header h2{
  margin:0;
  font-weight:900;
  font-size:22px;
}

.page-header small{
  font-size:13px;
  color:#64748b;
}

/* KPIs */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:22px;
  margin-bottom:30px;
}

.kpi{
  background:#fff;
  padding:26px;
  border-radius:18px;
  box-shadow:0 15px 35px rgba(0,0,0,.06);
  border:1px solid rgba(0,0,0,.05);
  transition:.25s ease;
}

.kpi:hover{
  transform:translateY(-4px);
}

.kpi h3{
  margin:0;
  font-size:12px;
  text-transform:uppercase;
  color:#64748b;
}

.kpi .value{
  font-size:34px;
  font-weight:900;
  margin-top:12px;
  color:#006EB3;
}

/* Alerts */
.security-alerts{
  background:#fff;
  border-radius:18px;
  padding:25px;
  margin-bottom:30px;
  border-left:6px solid #E11D48;
  box-shadow:0 15px 35px rgba(0,0,0,.05);
}

.alert-box{
  padding:12px 14px;
  border-radius:10px;
  margin-top:10px;
  font-size:13px;
  font-weight:600;
}

.alert-box.danger{ background:#fee2e2; color:#991b1b; }
.alert-box.warning{ background:#fff7ed; color:#c2410c; }

/* Cards */
.card{
  background:#fff;
  padding:26px;
  border-radius:18px;
  box-shadow:0 18px 40px rgba(0,0,0,.06);
  border:1px solid rgba(0,0,0,.05);
  margin-bottom:30px;
}

.card h3{
  margin:0 0 20px 0;
  font-size:15px;
  font-weight:800;
}

/* Chart */
.chart-wrap{ height:320px; position:relative; }

/* Table */
.table-wrapper{
  max-height:500px;
  overflow:auto;
  border-radius:14px;
}

.audit-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
}

.audit-table thead{
  background:#f8fafc;
}

.audit-table th{
  padding:14px 12px;
  text-align:left;
  font-weight:700;
  font-size:12px;
  text-transform:uppercase;
  color:#64748b;
  border-bottom:1px solid rgba(0,0,0,.06);
  position:sticky;
  top:0;
  background:#f8fafc;
  z-index:5;
}

.audit-table td{
  padding:14px 12px;
  border-bottom:1px solid rgba(0,0,0,.05);
}

.audit-table tbody tr:hover{ background:#f1f7ff; }

.audit-danger{ background:#fff1f2 !important; }

/* Badges */
.audit-badge{
  padding:5px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  display:inline-block;
}

.badge-view{ background:#e0f2fe; color:#0369a1; }
.badge-create{ background:#dcfce7; color:#166534; }
.badge-edit{ background:#fef9c3; color:#854d0e; }
.badge-delete{ background:#fee2e2; color:#991b1b; }
.badge-attempt_disabled{ background:#ffe4e6; color:#be123c; }

/* Controls */
.table-controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:15px;
}

.table-controls input,
.table-controls select,
.table-controls button{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:13px;
}

.table-controls button{
  cursor:pointer;
  background:#006EB3;
  color:#fff;
  border:none;
}

.table-controls button:hover{
  background:#004f85;
}

/* Pagination */
.pagination{
  display:flex;
  justify-content:center;
  margin-top:20px;
  gap:8px;
}

.pagination a, .pagination span{
  padding:8px 14px;
  border-radius:8px;
  font-size:13px;
  text-decoration:none;
  border:1px solid rgba(0,0,0,.1);
  background:#fff;
}

.pagination .active{
  background:#006EB3;
  color:#fff;
}
</style>

<div class="page">

<div class="page-header">
  <h2>Security Monitoring Dashboard</h2>
  <small>Real-Time Audit & Threat Intelligence</small>
</div>

<div class="kpi-grid">
  <div class="kpi"><h3>Total Logs</h3><div class="value">{{ total_logs|default:0 }}</div></div>
  <div class="kpi"><h3>Today Logs</h3><div class="value">{{ today_logs|default:0 }}</div></div>
  <div class="kpi"><h3>Disabled Attempts Today</h3><div class="value">{{ disabled_today|default:0 }}</div></div>
  <div class="kpi">
    <h3>Most Active User</h3>
    <div class="value">
      {% if most_active_user %}{{ most_active_user.user__username }}{% else %}-{% endif %}
    </div>
  </div>
</div>

{% if suspicious_users or risky_documents %}
<div class="security-alerts">
  <h3>Security Alerts (Last 24 Hours)</h3>
  {% for user in suspicious_users %}
  <div class="alert-box danger">
    User {{ user.user__username }} attempted {{ user.total }} disabled accesses.
  </div>
  {% endfor %}
  {% for doc in risky_documents %}
  <div class="alert-box warning">
    Document {{ doc.document__title }} has {{ doc.total }} blocked attempts.
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="card">
  <h3>Activity Distribution</h3>
  <div class="chart-wrap">
    <canvas id="activityChart"></canvas>
  </div>
</div>

<div class="card">
  <h3>Recent Activity</h3>

  <div class="table-controls">
    <input type="text" id="searchInput" placeholder="Search...">
    <select id="actionFilter">
      <option value="">All Actions</option>
      <option value="view">View</option>
      <option value="create">Create</option>
      <option value="edit">Edit</option>
      <option value="delete">Delete</option>
      <option value="attempt_disabled">Blocked</option>
    </select>
    <button onclick="exportTable()">Export CSV</button>
  </div>

  <div class="table-wrapper">
    <table class="audit-table" id="auditTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Action</th>
          <th>Document</th>
          <th>Department</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% for log in page_obj %}
        <tr class="{% if log.action == 'attempt_disabled' %}audit-danger{% endif %}" data-action="{{ log.action }}">
          <td>{{ log.user.username|default:"System" }}</td>
          <td><span class="audit-badge badge-{{ log.action }}">{{ log.get_action_display }}</span></td>
          <td><strong>{{ log.document.title }}</strong></td>
          <td>{{ log.department.name|default:"-" }}</td>
          <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" style="text-align:center;padding:20px;">No activity recorded.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="pagination">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
    {% endif %}
    <span class="active">{{ page_obj.number }}</span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">Next</a>
    {% endif %}
  </div>

</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

  /* Chart */
  const ctx = document.getElementById('activityChart');
  if(ctx){
    let labels = JSON.parse('{{ context_labels|escapejs }}');
    let data = JSON.parse('{{ context_data|escapejs }}');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Activity Count',
          data: data,
          backgroundColor: ['#006EB3','#1F9D55','#F5A524','#E11D48'],
          borderRadius: 8
        }]
      },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} } }
    });
  }

  /* Search + Filter */
  const search = document.getElementById("searchInput");
  const filter = document.getElementById("actionFilter");
  const rows = document.querySelectorAll("#auditTable tbody tr");

  function applyFilter(){
    const text = search.value.toLowerCase();
    const action = filter.value;

    rows.forEach(row=>{
      const matchText = row.innerText.toLowerCase().includes(text);
      const matchAction = !action || row.dataset.action === action;
      row.style.display = (matchText && matchAction) ? "" : "none";
    });
  }

  search.addEventListener("keyup", applyFilter);
  filter.addEventListener("change", applyFilter);

});

/* Export CSV */
function exportTable(){
  const rows = document.querySelectorAll("#auditTable tr");
  let csv = [];
  rows.forEach(row=>{
    const cols = row.querySelectorAll("th, td");
    const rowData = [];
    cols.forEach(col => rowData.push('"' + col.innerText.replace(/"/g,'""') + '"'));
    csv.push(rowData.join(","));
  });
  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "audit_export.csv";
  link.click();
}
</script>

{% include "qms-templates/footer.html" %}