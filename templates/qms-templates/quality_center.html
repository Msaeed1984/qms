{# qms-templates/quality_center.html #}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QMS ‚Ä¢ Quality Control Center</title>
<script src="https://unpkg.com/lucide@latest"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const KPI_URL = "{% url 'core:kpi_enterprise' %}";
</script>
<style>
:root{
  --em-blue:#006EB3;
  --em-green:#5BC500;
  --bg:#f4f7fb;
  --text:#0B1220;
  --muted:rgba(11,18,32,.60);
  --line:rgba(11,18,32,.08);
  --shadow:0 20px 45px rgba(0,0,0,.08);
  --r:18px;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma;
  background:var(--bg);
  color:var(--text);
}

.page{
  max-width:1800px;   /* ÿ£ÿπÿ±ÿ∂ ŸÇŸÑŸäŸÑÿßŸã */
  margin:20px auto;
  padding:0 20px 60px;  /* ŸÖÿ≥ÿßŸÅÿ© ÿ¨ÿßŸÜÿ®Ÿäÿ© ÿ£ÿÆŸÅ */
}
/* HEADER */
.header-card{
  background:#fff;
  border-radius:var(--r);
  padding:30px;
  box-shadow:var(--shadow);
}

.header-card h1{
  margin:0;
  font-size:26px;
  font-weight:900;
}

.header-card p{
  margin-top:10px;
  color:var(--muted);
}

/* ===============================
   Modern KPI Cards ‚Äì Bottom Line Style
=================================*/

.kpis{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:20px;
  margin-top:10px;
}

.kpi{
  background:#fff;
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.05);
  border:1px solid var(--line);
  transition:all .25s ease;

  display:flex;
  flex-direction:column;
  height:170px;             /* ÿ™Ÿàÿ≠ŸäÿØ ŸÉÿßŸÖŸÑ */
  position:relative;
  overflow:hidden;
}

.kpi-top{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:13px;
  font-weight:700;
  color:var(--muted);
}

.kpi-top i{
  width:20px;
  height:20px;
  transition:all .25s ease;
}

.kpi-value{
  flex:1;                   /* Ÿäÿ£ÿÆÿ∞ ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑŸàÿ≥ÿ∑Ÿâ */
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:50px;
  font-weight:900;
}

#kpi-documents-trend{
  text-align:center;
  font-size:12px;
  font-weight:700;
}

.kpi:hover{
  transform:translateY(-3px);
  box-shadow:0 18px 35px rgba(0,0,0,.08);
}

.kpi::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg, rgba(255,255,255,.5), transparent);
  opacity:0;
  transition:opacity .3s ease;
}

.kpi:hover::before{
  opacity:.4;
}
.kpi-top{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:13px;
  font-weight:700;
  color:var(--muted);
}

.kpi-top i{
  width:20px;
  height:20px;
}

.kpi-value{
  font-size:54px;        /* üëà ÿ£ŸÉÿ®ÿ± Ÿàÿ£Ÿàÿ∂ÿ≠ */
  font-weight:900;
  letter-spacing:.5px;
  margin-top:10px;
  text-align:center;
}

.kpi.blue .kpi-value{
  color:#006EB3;
}

.kpi.green .kpi-value{
  color:#5BC500;
}

.kpi.gray .kpi-value{
  color:#7b8794;
}

.kpi.purple .kpi-value{
  color:#644f8a;
}

.kpi.cyan .kpi-value{
  color:#0891b2;
}

.kpi.orange .kpi-value{
  color:#f59e0b;
}
/* ===============================
   Bottom Color Line
=================================*/

.kpi::after{
  content:"";
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:5px;
  border-radius:0 0 16px 16px;
}

/* üé® Color Variants */

.kpi.blue::after{
  background:#006EB3;
}

.kpi.green::after{
  background:#5BC500;
}

.kpi.gray::after{
  background:#7b8794;
}

.kpi.purple::after{
  background:#53308f;
}

.kpi.cyan::after{
  background:#0891b2;
}

.kpi.orange::after{
  background:#f59e0b;
}
/* ============================= */
/* COLOR GLOW HOVER EFFECT */
/* ============================= */

.kpi.blue:hover{
  box-shadow:
    0 15px 35px rgba(0,0,0,.08),
    0 0 0 1px rgba(0,110,179,.15),
    0 12px 30px rgba(0,110,179,.18);
}

.kpi.green:hover{
  box-shadow:
    0 15px 35px rgba(0,0,0,.08),
    0 0 0 1px rgba(91,197,0,.15),
    0 12px 30px rgba(91,197,0,.18);
}

.kpi.gray:hover{
  box-shadow:
    0 15px 35px rgba(0,0,0,.08),
    0 0 0 1px rgba(123,135,148,.15),
    0 12px 30px rgba(123,135,148,.18);
}

.kpi.purple:hover{
  box-shadow:
    0 15px 35px rgba(0,0,0,.08),
    0 0 0 1px rgba(124,58,237,.15),
    0 12px 30px rgba(124,58,237,.18);
}

.kpi.cyan:hover{
  box-shadow:
    0 15px 35px rgba(0,0,0,.08),
    0 0 0 1px rgba(8,145,178,.15),
    0 12px 30px rgba(8,145,178,.18);
}

.kpi.orange:hover{
  box-shadow:
    0 15px 35px rgba(0,0,0,.08),
    0 0 0 1px rgba(245,158,11,.15),
    0 12px 30px rgba(245,158,11,.18);
}

/* ICON COLOR ON HOVER */

.kpi.blue:hover .kpi-top i{
  color:#006EB3;
}

.kpi.green:hover .kpi-top i{
  color:#5BC500;
}

.kpi.gray:hover .kpi-top i{
  color:#7b8794;
}

.kpi.purple:hover .kpi-top i{
  color:#7c3aed;
}

.kpi.cyan:hover .kpi-top i{
  color:#0891b2;
}

.kpi.orange:hover .kpi-top i{
  color:#f59e0b;
}
/* CHART SECTION */
/* =========================
   Charts Layout (Balanced)
========================= */
.charts{
  display:grid;
  grid-template-columns: 2fr 1fr;   /* ‚¨Ö ÿ£ŸáŸÖ ÿ™ÿπÿØŸäŸÑ */
  gap:25px;
  margin-top:35px;
  align-items:stretch;              /* ‚¨Ö Ÿäÿ¨ÿπŸÑ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ ŸÖÿ™ÿ≥ÿßŸàŸä */
}

.chart-card{
  background:#fff;
  border-radius:var(--r);
  padding:20px;
  box-shadow:var(--shadow);
  border:1px solid var(--line);

  height:380px;          /* ‚¨Ö ŸÜŸÅÿ≥ ÿ∑ŸàŸÑ Recent Activity ÿ™ŸÇÿ±Ÿäÿ®ÿßŸã */
  display:flex;
  flex-direction:column;
}
/* ===== Modern Action Card ===== */

.modern-action-card{
  padding:30px;
}

.action-content{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:40px;
}

.action-chart-wrapper{
  position:relative;
  width:45%;
  min-width:280px;
}

.action-chart-wrapper canvas{
  width:100% !important;
}

.donut-center{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}

.donut-total{
  font-size:34px;
  font-weight:900;
  color:#0B1220;
}

.donut-label{
  font-size:12px;
  font-weight:700;
  color:var(--muted);
}

/* Legend */

.action-legend{
  width:55%;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.legend-item{
  display:flex;
  flex-direction:column;
  gap:6px;
  padding:12px 16px;
  border-radius:12px;
  background:#f8fafc;
  transition:.25s ease;
  cursor:pointer;
}

.legend-item:hover{
  background:#eef2f7;
  transform:translateX(6px);
}

.legend-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.legend-left{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
}

.legend-color{
  width:12px;
  height:12px;
  border-radius:4px;
}

.legend-value{
  font-weight:900;
}

.legend-progress{
  height:6px;
  background:#e2e8f0;
  border-radius:6px;
  overflow:hidden;
}

.legend-progress-bar{
  height:100%;
  border-radius:6px;
  transition:width .6s ease;
}

.chart-card h3{
  margin:0 0 15px 0;
  font-size:14px;
  font-weight:800;
}
.chart-card canvas{
  flex:1;
  max-height:280px;   /* ŸäŸÖŸÜÿπ ÿßŸÑÿ™ÿ∂ÿÆŸÖ */
}
/* ===============================
   Risk Intelligence Panel
=================================*/

.risk-card{
  padding:30px;
}

.risk-items{
  display:flex;
  flex-direction:column;
  gap:18px;
}

.risk-item{
  display:flex;
  align-items:center;
  gap:15px;
  padding:14px 16px;
  border-radius:14px;
  background:#f8fafc;
  transition:.25s ease;
}

.risk-item:hover{
  transform:translateX(6px);
  background:#eef2f7;
}

.risk-icon{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  background:#e2e8f0;
}

.risk-icon i{
  width:18px;
  height:18px;
}

.risk-content{
  flex:1;
}

.risk-label{
  font-size:12px;
  font-weight:700;
  color:var(--muted);
}

.risk-value{
  font-size:18px;
  font-weight:900;
}

/* Color States */

.risk-item.danger .risk-icon{
  background:rgba(225,29,72,.12);
  color:#E11D48;
}

.risk-item.warning .risk-icon{
  background:rgba(245,158,11,.12);
  color:#f59e0b;
}

.risk-item.info .risk-icon{
  background:rgba(0,110,179,.12);
  color:#006EB3;
}

.risk-item.success .risk-icon{
  background:rgba(91,197,0,.12);
  color:#5BC500;
}

.security-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:25px;
  height:100%;               /* ‚¨Ö ŸÖŸáŸÖ */
}

.security-grid > .security-box{
  height:100%;
}

.security-box{
  background:#fff;
  border-radius:18px;
  padding:30px;
  border:1px solid var(--line);
  box-shadow:0 10px 30px rgba(0,0,0,.05);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:180px;
  text-align:center;
  transition:.25s ease;
}

.security-box:hover{
  transform:translateY(-6px);
  box-shadow:0 18px 35px rgba(0,0,0,.08);
}

.sec-icon{
  width:45px;
  height:45px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:12px;
  background:#f1f5f9;
}

.sec-value{
  font-size:36px;
  font-weight:900;
  margin-bottom:6px;
}

.sec-value.small{
  font-size:16px;
  word-break:break-word;
}

.sec-title{
  font-size:13px;
  font-weight:700;
  color:var(--muted);
}

/* Dynamic Risk Colors */

.security-box.low .sec-value{ color:#22c55e; }
.security-box.medium .sec-value{ color:#f59e0b; }
.security-box.high .sec-value{ color:#ef4444; }
.security-box.danger .sec-value{ color:#ef4444; }
.security-box.info .sec-value{ color:#006EB3; }

/* TABLES */
.tables{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:30px;
  margin-top:40px;
}

.table-card{
  background:#fff;
  border-radius:var(--r);
  padding:25px;
  box-shadow:var(--shadow);
  border:1px solid var(--line);
}

.table-card h3{
  margin:0 0 18px 0;
  font-size:16px;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:10px;
}

/* TABLE STYLE ENTERPRISE */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}

thead{
  background:#f8fafc;
}

th{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.5px;
  font-weight:500;          /* üëà ŸÑŸäÿ≥ ÿ®ŸàŸÑÿØ */
  padding:12px 10px;
  border-bottom:1px solid var(--line);
  color:#64748b;
  text-align:center;        /* üëà ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿµŸÅ */
}

td{
  padding:14px 10px;
  font-size:14px;
  font-weight:400;          /* üëà ÿπÿßÿØŸä */
  border-bottom:1px solid #f1f5f9;
  vertical-align:middle;
  text-align:center;        /* üëà ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿµŸÅ */
}

tbody tr{
  transition:.2s ease;
}

tbody tr:hover{
  background:#f9fbfd;
}

tbody tr:last-child td{
  border-bottom:none;
}

/* Status Badges */
.status-badge{
  padding:5px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:500;
}

.status-active{
  background:rgba(31,157,85,.10);
  color:#1F9D55;
}

.status-disabled{
  background:rgba(245,165,36,.12);
  color:#f59e0b;
}

.status-archived{
  background:rgba(225,29,72,.10);
  color:#E11D48;
}

/* ========================================= */

@media(max-width:1200px){
  .kpis{grid-template-columns:repeat(3,1fr);}
  .charts{grid-template-columns:1fr;}
  .tables{grid-template-columns:1fr;}
}

.range-bar.modern-range{
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:#fff;
    padding:18px 22px;
    border-radius:16px;
    box-shadow:0 15px 35px rgba(0,0,0,.06);
    margin-bottom:18px;
    border:1px solid var(--line);
  }

  .range-left{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:700;
    font-size:14px;
  }

  .range-segment{
    display:flex;
    gap:6px;
    background:#f3f6fa;
    padding:6px;
    border-radius:999px;
    border:1px solid #e7eef6;
  }

  .range-segment button{
    padding:8px 16px;
    border-radius:999px;
    border:0;
    background:transparent;
    font-weight:600;
    font-size:13px;
    cursor:pointer;
    transition:.15s ease;
  }

  .range-segment button:hover{
    background:rgba(0,110,179,.08);
  }

  .range-segment button.active{
    background:#006EB3;
    color:#fff;
    box-shadow:0 8px 20px rgba(0,110,179,.25);
  }

.card-header-flex{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
}

.audit-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:8px;
  font-size:12px;
  font-weight:800;
  text-decoration:none;
  background:#006EB3;
  color:#fff;
  transition:.2s ease;
}

.audit-btn:hover{
  background:#004f85;
  transform:translateY(-2px);
}

</style>
</head>

<body>

{% include "qms-templates/header.html" %}

<div class="page">

  <div class="range-bar modern-range">

    <div class="range-left">
      <i data-lucide="calendar"></i>
      <span>Time Range</span>
    </div>

    <div class="range-segment" id="rangeSegment">
      <button data-range="1">Today</button>
      <button data-range="7">7d</button>
      <button data-range="30">30d</button>
      <button data-range="90">90d</button>
      <button data-range="365">Year</button>
    </div>

  </div>

<!-- KPI -->
<div class="kpis">

  <div class="kpi blue">

    <div class="kpi-top">
      <i data-lucide="file-text"></i>
      <span>Documents</span>
    </div>

    <div class="kpi-value count-up"
        data-value="{{ kpi_total_docs }}">
      {{ kpi_total_docs }}
    </div>

    <!-- Trend -->
    <div id="kpi-documents-trend"
        style="font-size:12px;font-weight:700;margin-top:6px;">
    </div>

    <!-- Disabled Badge -->
    <div style="
          position:absolute;
          top:12px;
          right:12px;
          background:rgba(239,68,68,.12);
          color:#ef4444;
          font-size:11px;
          font-weight:700;
          padding:4px 8px;
          border-radius:12px;
  ">
        <span id="disabledCount">{{ disabled_docs }}</span> Disabled
    </div>

  </div>


    <div class="kpi green">

      <div class="kpi-top">
        <i data-lucide="check-circle"></i>
        <span>Active</span>
      </div>

      <div class="kpi-value count-up"
          data-value="{{ kpi_active_docs }}">
        {{ kpi_active_docs }}
      </div>

    

    </div>

  <div class="kpi gray">
    <div class="kpi-top">
      <i data-lucide="archive"></i>
      <span>Archived</span>
    </div>
    <div class="kpi-value count-up"
    
     data-value="{{ kpi_archived_docs }}">
    {{ kpi_archived_docs }}
</div>

  </div>

  <div class="kpi purple">
    <div class="kpi-top">
      <i data-lucide="building-2"></i>
      <span>Departments</span>
    </div>
    <div class="kpi-value count-up"
 
     data-value="{{ kpi_departments }}">
    {{ kpi_departments }}
</div>
  </div>

  <div class="kpi cyan">
    <div class="kpi-top">
      <i data-lucide="users"></i>
      <span>Users</span>
    </div>

      <div class="kpi-value count-up"
     data-value="{{ kpi_users }}">
    {{ kpi_users }}
</div>
  </div>

  <div class="kpi orange">
    <div class="kpi-top">
      <i data-lucide="activity"></i>
      <span>Activity Logs</span>
    </div>
    <div class="kpi-value count-up"
     data-value="{{ kpi_activities }}">
    {{ kpi_activities }}
</div>
  </div>

</div>

<!-- Charts -->
<div class="charts">

  <div class="chart-card modern-action-card">
  <h3 style="margin-bottom:20px;">
    <i data-lucide="pie-chart"></i>
    Activity by Action
  </h3>

  <div class="action-content">

    <div class="action-chart-wrapper">
      <canvas id="actionChart"></canvas>
      <div class="donut-center">
        <div class="donut-total" id="donutTotal">0</div>
        <div class="donut-label">Total</div>
      </div>
    </div>

    <div class="action-legend" id="actionLegend"></div>

  </div>
</div>

<div class="security-grid">

      <div class="security-box danger">
        <div class="sec-icon">
          <i data-lucide="alert-triangle"></i>
        </div>
        <div class="sec-value risk-attempts">
            {{ risk_disabled_attempts|default:0 }}
        </div>
        <div class="sec-title">Disabled Attempts</div>
    </div>

      <div class="security-box {{ risk_level|lower }}">
        <div class="sec-icon">
          <i data-lucide="activity"></i>
        </div>
        <div class="sec-value risk-level">
            {{ risk_level }}
        </div>
        <div class="sec-title">Risk Level</div>
    </div>

      <div class="security-box info">
        <div class="sec-icon">
          <i data-lucide="user"></i>
        </div>
        <div class="sec-value small risk-user">
            {{ risk_top_user }}
        </div>
        <div class="sec-title">Top Active User</div>
    </div>

  <div class="security-box info">
    <div class="sec-icon">
      <i data-lucide="file-text"></i>
    </div>
    <div class="sec-value small risk-doc">
        {{ risk_top_document }}
    </div>
    <div class="sec-title">Top Accessed Document</div>
</div>

</div>
</div>

<!-- Department Distribution -->
<div class="chart-card" style="margin-top:40px;">
  <h3>Department Distribution</h3>
  <canvas id="deptChart"></canvas>
</div>


<!-- Tables -->
<div class="tables">

<div class="table-card">
<h3>Recent Documents</h3>
<table>
<thead>
<tr>
<th>Document</th>
<th>Department</th>
<th>Status</th>
<th>Updated</th>
</tr>
</thead>
<tbody>
{% for d in recent_docs %}
<tr>
<td><b>{{ d.title }}</b></td>
<td>{{ d.department.name }}</td>
<td>
  <span class="status-badge status-{{ d.status }}">
    {{ d.get_status_display }}
  </span>
</td>
<td>{{ d.updated_at|date:"Y-m-d" }}</td>
</tr>
{% empty %}
<tr><td colspan="4">No data</td></tr>
{% endfor %}
</tbody>
</table>
</div>
<div class="table-card">

  <div class="card-header-flex">
    <h3>
      <i data-lucide="activity"></i>
      Recent Activity
    </h3>

    <a href="{% url 'documents:audit_dashboard' %}" class="audit-btn">
      <i data-lucide="shield"></i>
      View Full Audit
    </a>
  </div>

  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Action</th>
        <th>Document</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody>
      {% for a in recent_activities %}
      <tr>
        <td>{{ a.user }}</td>

        <td>
          <span style="font-weight:700; color:#006EB3;">
            {{ a.get_action_display }}
          </span>
        </td>

        <td>
          <span style="font-weight:600;">
            {{ a.document.title }}
          </span>
        </td>

        <td>{{ a.timestamp|date:"Y-m-d H:i" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">No activity</td></tr>
      {% endfor %}
    </tbody>
  </table>

</div>

</div>

</div>

{% include "qms-templates/footer.html" %}

{{ weekly_labels|json_script:"weekly-labels-data" }}
{{ weekly_values|json_script:"weekly-values-data" }}
{{ action_labels|json_script:"action-labels-data" }}
{{ action_values|json_script:"action-values-data" }}
{{ dept_labels|json_script:"dept-labels-data" }}
{{ dept_values|json_script:"dept-values-data" }}

<script>
const weeklyLabels = JSON.parse(
  document.getElementById('weekly-labels-data').textContent
);
const weeklyValues = JSON.parse(
  document.getElementById('weekly-values-data').textContent
);

const actionLabels = JSON.parse(
  document.getElementById('action-labels-data').textContent
);
const actionValues = JSON.parse(
  document.getElementById('action-values-data').textContent
);

const deptLabels = JSON.parse(
  document.getElementById('dept-labels-data').textContent
);
const deptValues = JSON.parse(
  document.getElementById('dept-values-data').textContent
);


// Weekly Chart
// Weekly Chart (Safe Init)
const weeklyCanvas = document.getElementById('weeklyChart');
if (weeklyCanvas) {
  new Chart(weeklyCanvas,{
    type:'line',
    data:{
      labels: weeklyLabels,
      datasets:[{
        label:'Activity',
        data: weeklyValues,
        borderColor:'#006EB3',
        backgroundColor:'rgba(0,110,179,.1)',
        fill:true,
        tension:.4
      }]
    }
  });
}

// Action Chart
/* ==========================
   Advanced Action Chart
==========================*/

const actionColors = ['#006EB3','#5BC500','#F5A524','#E11D48'];

const totalActions = actionValues.reduce((a,b)=>a+b,0);
document.getElementById("donutTotal").innerText = totalActions;

const actionChartInstance = new Chart(
  document.getElementById('actionChart'),
  {
    type:'doughnut',
    data:{
      labels: actionLabels,
      datasets:[{
        data: actionValues,
        backgroundColor: actionColors,
        borderWidth:0,
        hoverOffset:20
      }]
    },
    options:{
      cutout:'75%',
      animation:{
        animateScale:true,
        animateRotate:true
      },
      plugins:{
        legend:{ display:false }
      }
    }
  }
);

/* ===== Modern Interactive Legend ===== */

const legendContainer = document.getElementById("actionLegend");

actionLabels.forEach((label,index)=>{

  const value = actionValues[index];
  const percent = totalActions ? ((value/totalActions)*100) : 0;

  const item = document.createElement("div");
  item.className = "legend-item";

  item.innerHTML = `
    <div class="legend-top">
      <div class="legend-left">
        <div class="legend-color" style="background:${actionColors[index]}"></div>
        ${label}
      </div>
      <div class="legend-value">${value}</div>
    </div>
    <div class="legend-progress">
      <div class="legend-progress-bar"
           style="width:${percent}%; background:${actionColors[index]}">
      </div>
    </div>
  `;

  item.addEventListener("mouseenter", () => {
    actionChartInstance.setActiveElements([{datasetIndex:0,index:index}]);
    actionChartInstance.update();
  });

  item.addEventListener("mouseleave", () => {
    actionChartInstance.setActiveElements([]);
    actionChartInstance.update();
  });

  legendContainer.appendChild(item);
});

// Department Chart
new Chart(document.getElementById('deptChart'),{
  type:'bar',
  data:{
    labels: deptLabels,
    datasets:[{
      label:'Documents',
      data: deptValues,
      backgroundColor:'#5BC500'
    }]
  }
});

lucide.createIcons();

// ==========================
// Enterprise KPI Engine
// ==========================

function animateValue(element, start, end, duration) {
    let startTime = null;

    function step(currentTime) {
        if (!startTime) startTime = currentTime;
        const progress = Math.min((currentTime - startTime) / duration, 1);
        element.innerText = Math.floor(progress * (end - start) + start);

        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    }

    window.requestAnimationFrame(step);
}

function loadEnterpriseKPI(rangeValue){

    fetch(`${KPI_URL}?range=${rangeValue}`)
    .then(res => res.json())
    .then(data => {

        if(data.error) return;

        // ================= Documents =================
        const docEl = document.querySelector(".kpi.blue .kpi-value");
        const trendEl = document.getElementById("kpi-documents-trend");

        if(docEl) docEl.textContent = data.documents.toLocaleString();

        if(trendEl){
            if(data.documents_change >= 0){
                trendEl.innerHTML =
                  `<span style="color:#1F9D55;">‚ñ≤ ${data.documents_change}% vs previous</span>`;
            }else{
                trendEl.innerHTML =
                  `<span style="color:#E11D48;">‚ñº ${Math.abs(data.documents_change)}% vs previous</span>`;
            }
        }

        // ================= KPI Updates =================
        const activeEl = document.querySelector(".kpi.green .kpi-value");
        const archivedEl = document.querySelector(".kpi.gray .kpi-value");
        const activitiesEl = document.querySelector(".kpi.orange .kpi-value");
        const usersEl = document.querySelector(".kpi.cyan .kpi-value");
        const deptEl = document.querySelector(".kpi.purple .kpi-value");

        if(activeEl) activeEl.textContent = data.active_docs.toLocaleString();
        if(archivedEl) archivedEl.textContent = data.archived_docs.toLocaleString();
        if(activitiesEl) activitiesEl.textContent = data.activities.toLocaleString();
        if(usersEl) usersEl.textContent = data.users.toLocaleString();
        if(deptEl) deptEl.textContent = data.departments.toLocaleString();

        if(deptEl) deptEl.textContent = data.departments.toLocaleString();

        // ================= Disabled Documents =================
        const disabledEl = document.getElementById("disabledCount");
        if(disabledEl && data.disabled_docs !== undefined){
            disabledEl.textContent = data.disabled_docs.toLocaleString();
      }

        // ================= üõ° Risk Update =================
        if(data.risk_attempts !== undefined){

            const riskAttemptsEl = document.querySelector(".risk-attempts");
            const riskLevelEl = document.querySelector(".risk-level");
            const riskUserEl = document.querySelector(".risk-user");
            const riskDocEl = document.querySelector(".risk-doc");

            if(riskAttemptsEl)
                riskAttemptsEl.textContent = data.risk_attempts.toLocaleString();

            if(riskLevelEl)
                riskLevelEl.textContent = data.risk_level;

            if(riskUserEl)
                riskUserEl.textContent = data.risk_top_user;

            if(riskDocEl)
                riskDocEl.textContent = data.risk_top_document;
        }

    })
    .catch(err => console.error("KPI Load Error:", err));
}

// ==========================
// Range Button Controller
// ==========================

document.querySelectorAll(".range-segment button")
.forEach(btn => {

    btn.addEventListener("click", function(){

        document.querySelectorAll(".range-segment button")
        .forEach(b => b.classList.remove("active"));

        this.classList.add("active");

        const range = this.getAttribute("data-range");

        loadEnterpriseKPI(range);
    });

});

function animateCounter(el, duration = 800) {

    const target = parseInt(el.getAttribute("data-value")) || 0;
    const startTime = performance.now();

    function update(currentTime) {
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const value = Math.floor(progress * target);
        el.textContent = value.toLocaleString();

        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            el.textContent = target.toLocaleString();
        }
    }

    requestAnimationFrame(update);
}

document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll(".count-up").forEach(el => {
        animateCounter(el);
    });
});

document.querySelector('[data-range="30"]').classList.add("active");
// Initial load
loadEnterpriseKPI(30);

</script>
</body>
</html>